import streamlit as st
import pandas as pd
import gspread
from oauth2client.service_account import ServiceAccountCredentials
from datetime import datetime
from fpdf import FPDF
import base64

# --- GOOGLE SHEETS KAPCSOLAT ---
def connect_to_sheets():
    try:
        scope = ["https://spreadsheets.google.com/feeds", "https://www.googleapis.com/auth/drive"]
        creds = ServiceAccountCredentials.from_json_keyfile_name("credentials.json", scope)
        client = gspread.authorize(creds)
        # Pontosan ez legyen a Google Sheets neve:
        sheet = client.open("Lidl_Projekt_Adatbazis").sheet1
        return sheet
    except Exception as e:
        st.error(f"Hiba a Google Sheets kapcsol√≥d√°sn√°l: {e}")
        return None

# --- PDF GENER√ÅL√ì FUNKCI√ì ---
def create_pdf():
    pdf = FPDF()
    pdf.add_page()
    pdf.add_font('DejaVu', '', 'https://github.com/reingart/pyfpdf/raw/master/font/DejaVuSans.ttf', uni=True)
    pdf.set_font('Arial', 'B', 16)
    pdf.cell(200, 10, "ALV√ÅLLALKOZ√ìI SZERZ≈êD√âS - SABLON", ln=True, align='C')
    pdf.ln(10)
    pdf.set_font('Arial', '', 12)
    pdf.multi_cell(0, 10, f"Projekt: Lidl Beton Terasz\nKelt: {datetime.now().strftime('%Y-%m-%d')}\n\nEz a dokumentum az Ani-Roll Kft. hivatalos szerz≈ëd√©smint√°ja.")
    return pdf.output(dest="S").encode("latin-1")

# --- OLDAL BE√ÅLL√çT√ÅSOK ---
st.set_page_config(page_title="Ani-Roll Cloud", layout="wide")

# Men√º
menu = st.sidebar.radio("Navig√°ci√≥", ["üìä Dashboard", "üìù Napi Jelent√©s", "üí∞ Kalkul√°tor", "üìÇ Dokumentumok"])

# --- DASHBOARD ---
if menu == "üìä Dashboard":
    st.title("üèóÔ∏è Projekt Ir√°ny√≠t√≥pult")
    
    sheet = connect_to_sheets()
    if sheet:
        data = sheet.get_all_records()
        df = pd.DataFrame(data)
        
        col1, col2, col3 = st.columns(3)
        with col1:
            st.metric("√ñsszes jelent√©s", len(df))
        with col2:
            st.metric("Utols√≥ munkav√©gz√©s", df['D√°tum'].iloc[-1] if not df.empty else "Nincs adat")
        with col3:
            st.metric("St√°tusz", "Akt√≠v", delta="Id≈ëben")
            
        st.subheader("Legut√≥bbi esem√©nyek (√âl≈ë a Sheets-b≈ël)")
        if not df.empty:
            st.dataframe(df.tail(5), use_container_width=True)
        else:
            st.write("M√©g nincs bek√ºld√∂tt jelent√©s.")

# --- NAPI JELENT√âS ---
elif menu == "üìù Napi Jelent√©s":
    st.header("Napi Munkahelyzeti Jelent√©s")
    with st.form("napi_form"):
        date = st.date_input("D√°tum", datetime.now())
        phase = st.selectbox("Munkaszakasz", ["F√∂ldmunka", "Zsaluz√°s", "Betonoz√°s", "Ajt√≥ny√≠l√°s", "Befejez√©s"])
        workers = st.number_input("L√©tsz√°m", min_value=1, value=4)
        desc = st.text_area("Munka r√©szletez√©se")
        weather = st.selectbox("Id≈ëj√°r√°s", ["Napos", "Felh≈ës", "Es≈ë", "Fagy"])
        
        submit = st.form_submit_button("K√ºld√©s a T√°bl√°zatba")
        
        if submit:
            sheet = connect_to_sheets()
            if sheet:
                # Sor: D√°tum, Munkaszakasz, L√©tsz√°m, Le√≠r√°s, Id≈ëj√°r√°s, Id≈ëb√©lyeg
                new_row = [str(date), phase, workers, desc, weather, datetime.now().strftime("%H:%M:%S")]
                sheet.append_row(new_row)
                st.success("Sikeresen mentve a Google Sheets-be!")
                st.balloons()

# --- KALKUL√ÅTOR ---
elif menu == "üí∞ Kalkul√°tor":
    st.header("K√∂tb√©r Sz√°m√≠t√°s")
    base = st.number_input("Nett√≥ szerz≈ëd√©ses √∂sszeg", value=5000000)
    days = st.slider("K√©sedelmes napok", 0, 30, 0)
    penalty = days * (base * 0.005)
    st.subheader(f"Levonand√≥ k√∂tb√©r: {penalty:,.0f} Ft")

# --- DOKUMENTUMOK ---
elif menu == "üìÇ Dokumentumok":
    st.header("Let√∂lthet≈ë Sablonok")
    if st.button("Alv√°llalkoz√≥i Szerz≈ëd√©s Gener√°l√°sa"):
        pdf_data = create_pdf()
        b64 = base64.b64encode(pdf_data).decode()
        href = f'<a href="data:application/octet-stream;base64,{b64}" download="szerzodes.pdf">Kattints ide a PDF let√∂lt√©s√©hez</a>'
        st.markdown(href, unsafe_allow_html=True)